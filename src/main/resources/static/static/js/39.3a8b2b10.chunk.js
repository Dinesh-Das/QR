"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[39],{4786:(e,a,t)=>{t.d(a,{A:()=>i});var s=t(8168),n=t(5043);const l={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}},{tag:"path",attrs:{d:"M464 336a48 48 0 1096 0 48 48 0 10-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"}}]},name:"info-circle",theme:"outlined"};var r=t(2172),o=function(e,a){return n.createElement(r.A,(0,s.A)({},e,{ref:a,icon:l}))};const i=n.forwardRef(o)},5991:(e,a,t)=>{t.d(a,{JB:()=>n,bj:()=>r,eC:()=>s,rt:()=>l});const s=function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return Array.isArray(e)?e:(console.warn("Data is not an array, using fallback:",{data:e,fallback:a}),a)},n=function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(!e)return t;if(!a)return s(e,t);const n=a.split(".");let l=e;for(const s of n){if(!l||"object"!==typeof l||!(s in l))return console.warn(`Key '${s}' not found in response:`,e),t;l=l[s]}return s(l,t)},l=e=>s(e).map(e=>"string"===typeof e?{name:e,id:e}:"object"===typeof e&&null!==e?{name:e.name||e.roleName||e.id||"Unknown Role",id:e.id||e.name||e.roleName||Math.random().toString(36),...e}:{name:"Unknown Role",id:Math.random().toString(36)}),r=e=>e?Array.isArray(e)?{assignedPlants:e,primaryPlant:e.length>0?e[0]:null}:"object"===typeof e?{assignedPlants:s(e.assignedPlants||e.plants),primaryPlant:e.primaryPlant||e.primary||null}:{assignedPlants:[],primaryPlant:null}:{assignedPlants:[],primaryPlant:null}},6039:(e,a,t)=>{t.r(a),t.d(a,{default:()=>ne});var s=t(6569),n=t(2261),l=t(5206),r=t(6051),o=t(5043),i=t(4135),c=t(579);class d extends o.Component{constructor(e){super(e),this.reportError=(e,a,t)=>{console.error("UserErrorBoundary caught an error:",{error:e.message,stack:e.stack,errorInfo:a,context:t,timestamp:(new Date).toISOString()})},this.handleRetry=()=>{this.setState({hasError:!1,error:null,errorInfo:null}),this.props.onRetry&&this.props.onRetry()},this.handleGoHome=()=>{window.location.href="/qrmfg"},this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,a){this.setState({error:e,errorInfo:a}),this.reportError(e,a,{level:"component",component:"UserManagement",context:this.props.context||"user-management"})}render(){return this.state.hasError?(0,c.jsx)(i.Ay,{status:"error",title:"User Management Error",subTitle:"Something went wrong while managing users. Please try again or contact support if the problem persists.",extra:[(0,c.jsx)(l.Ay,{type:"primary",onClick:this.handleRetry,children:"Try Again"},"retry"),(0,c.jsx)(l.Ay,{onClick:this.handleGoHome,children:"Go Home"},"home")],style:{padding:"50px 0"},children:!1}):this.props.children}}d.defaultProps={context:"user-management",onRetry:null};const u=d;var m=t(9098),g=t(2751),p=t(5444),f=t(6553),y=t(8348),h=t(599),b=t(6274),P=t(8502),v=t(4786),C=t(3927),A=t(9073),x=t(1686),w=t(6399),k=t(7419),j=t(1645),S=t(6649);const{Text:U,Title:E}=C.A,T=e=>{let{selectedRoles:a,roles:t,visible:s}=e;const[l,r]=(0,o.useState)(null),[i,d]=(0,o.useState)(!1),u=(0,o.useCallback)(()=>{if(!a||0===a.length)return null;const e=a[0],s=t.find(a=>a.id===e);if(!s)return null;let n=s.name;return n.startsWith("ROLE_")&&n.endsWith("_USER")?n=n.substring(5,n.length-5):n.startsWith("ROLE_")&&(n=n.substring(5)),n},[a,t]);if((0,o.useEffect)(()=>{(async()=>{const e=u();if(e&&s){d(!0);try{const a=await S.default.get(`/admin/notification-defaults/preview?role=${e}`);a.success&&r({role:e,preferences:a.defaultPreferences})}catch(a){console.error("Failed to load notification preferences preview:",a),r(null)}finally{d(!1)}}else r(null)})()},[a,t,s,u]),!s||!a||0===a.length)return null;const m=u();return(0,c.jsxs)(A.A,{title:(0,c.jsxs)("span",{children:[(0,c.jsx)(P.A,{style:{marginRight:8}}),"Notification Preferences Preview"]}),size:"small",style:{marginTop:16},children:[(0,c.jsx)(n.A,{message:"Default Notification Preferences",description:`The following notification preferences will be automatically created for this user based on their ${m} role.`,type:"info",showIcon:!0,icon:(0,c.jsx)(v.A,{}),style:{marginBottom:16}}),i?(0,c.jsxs)("div",{style:{textAlign:"center",padding:20},children:[(0,c.jsx)(x.A,{size:"small"}),(0,c.jsx)(U,{style:{marginLeft:8},children:"Loading preview..."})]}):l?(0,c.jsxs)("div",{children:[(0,c.jsxs)("div",{style:{marginBottom:12},children:[(0,c.jsx)(U,{strong:!0,children:"Primary Role: "}),(0,c.jsx)(w.A,{color:"blue",children:l.role})]}),(0,c.jsx)(E,{level:5,style:{marginBottom:12},children:"Notification Types:"}),(0,c.jsx)(k.A,{gutter:[8,8],children:Object.entries(l.preferences).map(e=>{let[a,t]=e;return(0,c.jsx)(j.A,{xs:24,sm:12,md:8,children:(0,c.jsxs)("div",{style:{padding:"6px 10px",backgroundColor:t?"#f6ffed":"#fff2f0",border:"1px solid "+(t?"#b7eb8f":"#ffccc7"),borderRadius:"4px",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,c.jsx)(U,{style:{fontSize:"12px"},children:a.replace(/_/g," ")}),(0,c.jsx)(w.A,{color:t?"success":"default",size:"small",children:t?"ON":"OFF"})]})},a)})}),(0,c.jsx)(n.A,{message:"User Customization",description:"After creation, the user can modify these preferences in their settings.",type:"success",showIcon:!0,style:{marginTop:12},size:"small"})]}):(0,c.jsx)(n.A,{message:"Preview Unavailable",description:"Could not load notification preferences preview for the selected role.",type:"warning",showIcon:!0,size:"small"})]})};T.defaultProps={selectedRoles:[]};const $=T;var I=t(617),R=t(8354),F=t(9799);const N=()=>{const[e,a]=(0,o.useState)([]),[t,n]=(0,o.useState)(!1),[l,r]=(0,o.useState)(null),i=(0,o.useCallback)(async e=>{n(!0),r(null);try{const t=await F.B.getAllLocations({signal:e});if(null===e||void 0===e||!e.aborted){const e=t.map(e=>({label:`${e.locationCode} - ${e.description}`,value:e.locationCode,key:e.locationCode}));a(e)}}catch(t){if(null===e||void 0===e||!e.aborted){console.error("Failed to fetch plants:",t),r(t.message),s.Ay.warning("Failed to fetch plants from location master, using fallback data");a([{label:"1107 - Manufacturing Unit 1107",value:"1107",key:"1107"},{label:"1106 - Manufacturing Unit 1106",value:"1106",key:"1106"},{label:"1104 - Manufacturing Unit 1104",value:"1104",key:"1104"},{label:"1103 - Manufacturing Unit 1103",value:"1103",key:"1103"},{label:"1102 - Manufacturing Unit 1102",value:"1102",key:"1102"}])}}finally{null!==e&&void 0!==e&&e.aborted||n(!1)}},[]),c=(0,o.useCallback)(a=>{const t=e.find(e=>e.value===a);return t?t.label:a},[e]),d=(0,o.useCallback)((e,a)=>{const t=[];return e&&0!==e.length||t.push("At least one plant must be assigned"),a&&e&&!e.includes(a)&&t.push("Primary plant must be one of the assigned plants"),t},[]),u=(0,o.useCallback)((e,a)=>{var t;return null===a||void 0===a||null===(t=a.label)||void 0===t?void 0:t.toLowerCase().includes(e.toLowerCase())},[]),m=(0,o.useCallback)(function(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter(e=>!a.includes(e.value))},[e]);(0,o.useEffect)(()=>{const e=new AbortController;return i(e.signal),()=>{e.abort()}},[i]);const g=(0,o.useMemo)(()=>e.map(e=>({...e,disabled:!1})),[e]);return{availablePlants:e,plantsLoading:t,error:l,fetchPlants:i,getPlantDescription:c,validatePlantAssignments:d,filterPlants:u,getAvailablePlantsForAssignment:m,primaryPlantOptions:g}},{Text:O}=C.A,M=o.memo(e=>{var a,t;let{selectedRoles:s,roles:r,form:i,initialValues:d={}}=e;const{availablePlants:u,plantsLoading:g,error:p,fetchPlants:y,filterPlants:h,validatePlantAssignments:b}=N(),P=(0,o.useMemo)(()=>{if(!s||!r)return!1;const e=r.filter(e=>"ROLE_PLANT_USER"===e.name||"PLANT_USER"===e.name).map(e=>e.id);return s.some(a=>e.includes(a))},[s,r]),v=(0,o.useCallback)(async()=>{const e=new AbortController;await y(e.signal)},[y]),C=(0,o.useCallback)((e,a)=>P?a&&0!==a.length?Promise.resolve():Promise.reject(new Error("Please select at least one plant for plant users!")):Promise.resolve(),[P]),A=(0,o.useCallback)((e,a)=>{if(!P)return Promise.resolve();const t=i.getFieldValue("assignedPlants")||[];return a&&!t.includes(a)?Promise.reject(new Error("Primary plant must be one of the assigned plants!")):Promise.resolve()},[P,i]),x=(0,o.useCallback)(e=>{const a=i.getFieldValue("primaryPlant");a&&!e.includes(a)&&i.setFieldValue("primaryPlant",void 0)},[i]),w=(0,o.useMemo)(()=>{const e=i.getFieldValue("assignedPlants")||[];return u.filter(a=>e.includes(a.value))},[u,i]);return(0,o.useEffect)(()=>{(d.assignedPlants||d.primaryPlant)&&i.setFieldsValue({assignedPlants:d.assignedPlants||[],primaryPlant:d.primaryPlant||null})},[d,i]),P?(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(R.A,{}),(0,c.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[(0,c.jsx)(O,{strong:!0,style:{color:"#1890ff"},children:"Plant Assignments"}),(0,c.jsx)(l.Ay,{size:"small",icon:(0,c.jsx)(I.A,{}),onClick:v,loading:g,"aria-label":"Refresh plants list","data-testid":"refresh-plants-button",children:"Refresh Plants"})]}),(0,c.jsx)(O,{type:"secondary",style:{display:"block",marginBottom:16,fontSize:"12px"},children:"Plant users need to be assigned to specific plants to access plant-specific data. Plants are loaded from Location Master."}),p&&(0,c.jsx)(n.A,{message:"Plant Loading Error",description:`Failed to load plants: ${p}. Using fallback data.`,type:"warning",showIcon:!0,style:{marginBottom:16},"data-testid":"plant-error-alert"}),(0,c.jsx)(m.A.Item,{name:"assignedPlants",label:"Assigned Plants",rules:[{validator:C}],hasFeedback:!0,tooltip:"Select all plants this user should have access to",children:(0,c.jsx)(f.A,{mode:"multiple",placeholder:"Select plants this user can access",loading:g,options:u,showSearch:!0,filterOption:h,onChange:x,"aria-label":"Assigned plants selection","data-testid":"assigned-plants-select",maxTagCount:"responsive",allowClear:!0})}),(0,c.jsx)(m.A.Item,{name:"primaryPlant",label:"Primary Plant",rules:[{validator:A}],hasFeedback:!0,tooltip:"The default plant that will be selected when the user logs in",children:(0,c.jsx)(f.A,{placeholder:"Select primary plant (optional)",allowClear:!0,loading:g,options:w,showSearch:!0,filterOption:h,"aria-label":"Primary plant selection","data-testid":"primary-plant-select",disabled:!(null!==(a=i.getFieldValue("assignedPlants"))&&void 0!==a&&a.length)})}),(null===(t=i.getFieldValue("assignedPlants"))||void 0===t?void 0:t.length)>0&&(0,c.jsx)("div",{style:{marginTop:-16,marginBottom:16},children:(0,c.jsx)(O,{type:"secondary",style:{fontSize:"11px"},children:"Primary plant will be auto-selected from assigned plants if not specified"})})]}):null});M.displayName="PlantAssignmentForm",M.defaultProps={selectedRoles:[],initialValues:{}};const L=M,B=o.memo(e=>{let{visible:a,editingUser:t,roles:s,onSave:n,onCancel:l,loading:r=!1}=e;const[i]=m.A.useForm(),[d,u]=(0,o.useState)([]),[P,v]=(0,o.useState)({}),C=(0,o.useMemo)(()=>Boolean(t),[t]),A=(0,o.useMemo)(()=>C?"Edit User":"Add User",[C]),x=(0,o.useMemo)(()=>({username:h.PT.username,email:h.PT.email,password:C?[]:h.PT.password,roles:[{required:!0,message:"Please select at least one role!"},{type:"array",min:1,message:"Please select at least one role!"}]}),[C]),w=(0,o.useMemo)(()=>s.map(e=>({label:e.name,value:e.id,key:e.id})),[s]),k=(0,o.useCallback)(async e=>{try{await n(e,t),i.resetFields()}catch(a){console.error("Error saving user:",a)}},[n,t,i]),j=(0,o.useCallback)(()=>{i.resetFields(),l()},[i,l]),S=(0,o.useCallback)(()=>{i.submit()},[i]),U=(0,o.useCallback)(async e=>{try{const a=await y.E.getUserPlantAssignments(e);return v(a||{}),a}catch(a){return console.warn("Could not load plant assignments for user:",a),v({}),{}}},[]);(0,o.useEffect)(()=>{if(a&&t){const e=(t.roles||[]).map(e=>null===e||void 0===e?void 0:e.id).filter(Boolean);u(e),i.setFieldsValue({username:t.username,email:t.email,roles:e}),U(t.username)}else a&&!t&&(u([]),v({}),i.resetFields())},[a,t,i,U]);return(0,c.jsx)(g.A,{title:A,open:a,onOk:S,onCancel:j,confirmLoading:r,destroyOnClose:!0,width:600,maskClosable:!1,"aria-labelledby":"user-modal-title","data-testid":"user-modal",children:(0,c.jsxs)(b.Ay,{form:i,labelCol:{span:6},wrapperCol:{span:18},onFinish:k,preserve:!1,"aria-label":`${A} form`,"data-testid":"user-form",componentName:"UserModal",enableSecurityLogging:!0,children:[(0,c.jsx)(b.lE,{name:"username",label:"Username",validationType:"username",hasFeedback:!0,children:(0,c.jsx)(b.eS,{placeholder:"Enter username",disabled:C,"aria-label":"Username input","data-testid":"username-input",validationType:"username",componentName:"UserModal",fieldName:"username"})}),(0,c.jsx)(b.lE,{name:"email",label:"Email",validationType:"email",hasFeedback:!0,children:(0,c.jsx)(b.eS,{placeholder:"Enter email address","aria-label":"Email input","data-testid":"email-input",validationType:"email",componentName:"UserModal",fieldName:"email"})}),!C&&(0,c.jsx)(b.lE,{name:"password",label:"Password",validationType:"password",hasFeedback:!0,children:(0,c.jsx)(p.A.Password,{placeholder:"Enter password","aria-label":"Password input","data-testid":"password-input"})}),(0,c.jsx)(m.A.Item,{name:"roles",label:"Roles",rules:x.roles,hasFeedback:!0,children:(0,c.jsx)(f.A,{mode:"multiple",placeholder:"Select user roles",options:w,"aria-label":"Roles selection","data-testid":"roles-select",showSearch:!0,filterOption:(e,a)=>{var t;return null===a||void 0===a||null===(t=a.label)||void 0===t?void 0:t.toLowerCase().includes(e.toLowerCase())},maxTagCount:"responsive",onChange:u})}),(0,c.jsx)(L,{selectedRoles:d,roles:s,form:i,initialValues:P}),!C&&(0,c.jsx)($,{selectedRoles:d,roles:s,visible:a})]})})});B.displayName="UserModal",B.defaultProps={editingUser:null,loading:!1};const z=B;var V=t(7407),D=t(1966),_=t(3217);const H=o.memo(e=>{let{users:a,loading:t,onEdit:s,onDelete:n,availablePlants:r=[]}=e;const i=(0,o.useCallback)(e=>{const a=r.find(a=>a.value===e);return a?a.label:e},[r]),d=(0,o.useMemo)(()=>[{title:"Username",dataIndex:"username",key:"username",sorter:(e,a)=>e.username.localeCompare(a.username),"aria-label":"Username column"},{title:"Email",dataIndex:"email",key:"email",sorter:(e,a)=>e.email.localeCompare(a.email),"aria-label":"Email column"},{title:"Roles",dataIndex:"roles",key:"roles","aria-label":"Roles column",render:e=>(Array.isArray(e)?e:[]).map(e=>(null===e||void 0===e?void 0:e.name)||e||"").filter(Boolean).join(", ")||"No roles assigned"},{title:"Assigned Plants",key:"plants","aria-label":"Assigned plants column",render:(e,a)=>{let t=[],s=null;if(a.plantAssignments&&(Array.isArray(a.plantAssignments)?t=a.plantAssignments:a.plantAssignments.assignedPlants&&Array.isArray(a.plantAssignments.assignedPlants)&&(t=a.plantAssignments.assignedPlants,s=a.plantAssignments.primaryPlant)),0===t.length&&a.assignedPlants&&(Array.isArray(a.assignedPlants)?t=a.assignedPlants:"string"===typeof a.assignedPlants&&a.assignedPlants.trim()&&(t=a.assignedPlants.split(",").map(e=>e.trim()).filter(Boolean)),s=a.primaryPlant),!t||0===t.length)return(0,c.jsx)("span",{style:{color:"#999"},"aria-label":"No plants assigned",children:"None"});const n=t.map(e=>i(e)).join(", ");return(0,c.jsxs)("div",{children:[(0,c.jsx)("div",{"aria-label":`Assigned plants: ${n}`,children:n}),s&&(0,c.jsxs)("div",{style:{fontSize:"11px",color:"#666"},"aria-label":`Primary plant: ${i(s)}`,children:["Primary: ",i(s)]})]})}},{title:"Actions",key:"actions","aria-label":"Actions column",render:(e,a)=>(0,c.jsxs)("div",{role:"group","aria-label":`Actions for user ${a.username}`,children:[(0,c.jsx)(l.Ay,{type:"link",icon:(0,c.jsx)(V.A,{}),onClick:()=>s(a),"aria-label":`Edit user ${a.username}`,"data-testid":`edit-button-${a.id}`,children:"Edit"}),(0,c.jsx)(l.Ay,{type:"link",danger:!0,icon:(0,c.jsx)(D.A,{}),onClick:()=>n(a.id),"aria-label":`Delete user ${a.username}`,"data-testid":`delete-button-${a.id}`,children:"Delete"})]})}],[s,n,i]),u=(0,o.useMemo)(()=>{const e=Array.isArray(a)?a:[];return{columns:d,dataSource:e,rowKey:"id",loading:t,pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(e,a)=>`${a[0]}-${a[1]} of ${e} users`,"aria-label":"User table pagination"},scroll:{x:800},size:"middle","aria-label":"Users table","data-testid":"users-table"}},[d,a,t]),m=Array.isArray(a)?a:[];return t||0!==m.length?(0,c.jsx)(_.A,{...u,locale:{emptyText:"No users found"}}):(0,c.jsx)("div",{style:{textAlign:"center",padding:"40px 0",color:"#999"},role:"status","aria-label":"No users found",children:'No users found. Click "Add User" to create the first user.'})});H.displayName="UserTable",H.defaultProps={users:[],loading:!1,availablePlants:[]};const q=H;var W=t(5991);const G=(()=>{try{return t(6649).default}catch(e){return console.warn("API client not available, using mock"),{get:()=>Promise.resolve([]),post:()=>Promise.resolve({}),put:()=>Promise.resolve({}),delete:()=>Promise.resolve({})}}})(),X="SET_LOADING",J="SET_USERS",Q="SET_ROLES",K="SET_ERROR",Z="SET_MODAL_VISIBLE",Y="SET_EDITING_USER",ee="RESET_MODAL",ae={users:[],roles:[],loading:!1,error:null,modalVisible:!1,editingUser:null},te=(e,a)=>{switch(a.type){case X:return{...e,loading:a.payload};case J:return{...e,users:a.payload,loading:!1,error:null};case Q:return{...e,roles:a.payload};case K:return{...e,error:a.payload,loading:!1};case Z:return{...e,modalVisible:a.payload};case Y:return{...e,editingUser:a.payload};case ee:return{...e,modalVisible:!1,editingUser:null};default:return e}};var se=t(3719);const ne=()=>{const{users:e,roles:a,loading:i,modalVisible:d,editingUser:m,actions:g}=(()=>{const[e,a]=(0,o.useReducer)(te,ae),t=(0,o.useCallback)(async e=>{a({type:X,payload:!0});try{const t=await G.get("/admin/users",{signal:e}),s=(0,W.JB)(t,"users"),n=await Promise.all(s.map(async a=>{try{const t=await y.E.getUserPlantAssignments(a.username,{signal:e});return{...a,roles:(0,W.rt)(a.roles),plantAssignments:(0,W.bj)(t)}}catch(t){return null!==e&&void 0!==e&&e.aborted||console.error("Error loading plant assignments:",t),{...a,roles:(0,W.rt)(a.roles),plantAssignments:(0,W.bj)(null)}}}));null!==e&&void 0!==e&&e.aborted||a({type:J,payload:n})}catch(t){null!==e&&void 0!==e&&e.aborted||(console.error("Error fetching users:",t),a({type:K,payload:t.message}),s.Ay.error("Failed to fetch users"),a({type:J,payload:[]}))}},[]),n=(0,o.useCallback)(async e=>{try{const t=await G.get("/admin/roles",{signal:e});if(null===e||void 0===e||!e.aborted){const e=(0,W.JB)(t,"roles");a({type:Q,payload:e})}}catch(t){null!==e&&void 0!==e&&e.aborted||(console.error("Failed to fetch roles:",t),s.Ay.error("Failed to fetch roles"),a({type:Q,payload:[]}))}},[]),l=(0,o.useCallback)(async e=>{try{await G.delete(`/admin/users/${e}`),s.Ay.success("User deleted successfully");const a=new AbortController;await t(a.signal)}catch(a){throw s.Ay.error("Failed to delete user"),a}},[t]),r=(0,o.useCallback)(async(e,n)=>{try{const{assignedPlants:r,primaryPlant:o,roles:i,...c}=e;if(n){if(await G.put(`/admin/users/${n.id}`,c),i&&i.length>0)try{await G.post(`/admin/users/${n.id}/roles`,{roleIds:i})}catch(l){console.warn("Failed to update user roles:",l),s.Ay.warning("User updated but roles could not be assigned")}r&&r.length>0&&await y.E.updateUserPlantAssignments(n.username,{assignedPlants:r,primaryPlant:o||r[0]}),s.Ay.success("User updated successfully")}else{const e={...c,roles:i||[],assignedPlants:r||[],primaryPlant:o||(r&&r.length>0?r[0]:null)},a=await G.post("/admin/users",e);console.log("User creation response:",a),"warning"===a.status?s.Ay.warning(a.message):(a.status,s.Ay.success("User created successfully"))}a({type:ee});const d=new AbortController;await t(d.signal)}catch(r){throw s.Ay.error("Failed to save user"),r}},[t]),i=(0,o.useCallback)(async e=>{a({type:Y,payload:e}),a({type:Z,payload:!0})},[]),c=(0,o.useCallback)(()=>{a({type:Y,payload:null}),a({type:Z,payload:!0})},[]),d=(0,o.useCallback)(()=>{a({type:ee})},[]);return(0,o.useEffect)(()=>{const e=new AbortController;return(async()=>{try{await Promise.all([t(e.signal),n(e.signal)])}catch(a){e.signal.aborted||console.error("Error initializing user management data:",a)}})(),()=>{e.abort()}},[t,n]),{...e,actions:{fetchUsers:t,fetchRoles:n,deleteUser:l,saveUser:r,openEditModal:i,openAddModal:c,closeModal:d}}})(),{availablePlants:p}=N(),f=(0,o.useCallback)(async()=>{try{const e=await F.B.testLocationMaster();s.Ay.success(e)}catch(e){s.Ay.error(`Test failed: ${e.message}`)}},[]),h=(0,o.useCallback)(async()=>{try{const e=await F.B.testSimpleLocation();s.Ay.success(e)}catch(e){s.Ay.error(`Simple test failed: ${e.message}`)}},[]),b=(0,o.useCallback)(async()=>{try{const e=await F.B.diagnosticLocationMaster();console.log("Diagnostic result:",e),s.Ay.info("Check console for diagnostic info")}catch(e){s.Ay.error(`Diagnostic failed: ${e.message}`)}},[]),P=(0,o.useCallback)(()=>{const e=new AbortController;g.fetchUsers(e.signal)},[g]),v=(0,o.useCallback)(async()=>{try{const e=(await Promise.resolve().then(t.bind(t,6649))).default,a=await e.get("/admin/test/user-roles");console.log("Test user roles result:",a),s.Ay.success("Test successful! Check console for user roles test data")}catch(e){console.error("Test user roles failed:",e),401===e.status?s.Ay.error("Authentication failed. Please log in first."):s.Ay.error(`Test failed: ${e.message}`)}},[]),C=(0,o.useCallback)(()=>{window.location.href="/qrmfg/login"},[]),A=(0,o.useCallback)(async()=>{try{const e=(await Promise.resolve().then(t.bind(t,6649))).default,a=await e.post("/admin/fix-admin-roles");console.log("Fix admin roles result:",a),s.Ay.success("Admin roles fixed! Refreshing user data...");const n=new AbortController;g.fetchUsers(n.signal)}catch(e){console.error("Fix admin roles failed:",e),s.Ay.error(`Fix failed: ${e.message}`)}},[g]),x=(0,se.HW)(),w=(0,se.Rk)(),k=(0,se.wR)();return(0,c.jsx)(u,{context:"user-management",onRetry:P,children:(0,c.jsxs)("div",{style:{padding:"24px"},children:[(0,c.jsx)(n.A,{message:`Debug Info: User: ${x||"Not logged in"}, Authenticated: ${k}, Roles: ${w.join(", ")||"None"}`,type:k?"info":"warning",style:{marginBottom:16},showIcon:!0,action:!k&&(0,c.jsx)(l.Ay,{size:"small",onClick:C,children:"Go to Login"})}),(0,c.jsx)("div",{style:{marginBottom:16},children:(0,c.jsxs)(r.A,{wrap:!0,children:[(0,c.jsx)(l.Ay,{type:"primary",onClick:g.openAddModal,"data-testid":"add-user-button",children:"Add User"}),(0,c.jsx)(l.Ay,{onClick:f,children:"Test Location API"}),(0,c.jsx)(l.Ay,{onClick:h,children:"Test Simple API"}),(0,c.jsx)(l.Ay,{onClick:b,children:"Diagnostic"}),(0,c.jsx)(l.Ay,{onClick:v,children:"Test User Roles"}),(0,c.jsx)(l.Ay,{onClick:A,type:"dashed",children:"Fix Admin Roles"})]})}),(0,c.jsx)(q,{users:e,loading:i,onEdit:g.openEditModal,onDelete:g.deleteUser,availablePlants:p}),(0,c.jsx)(z,{visible:d,editingUser:m,roles:a,onSave:g.saveUser,onCancel:g.closeModal,loading:i})]})})}},6274:(e,a,t)=>{t.d(a,{Ay:()=>p,eS:()=>d,lE:()=>g,wS:()=>u});var s=t(9098),n=t(5444),l=t(6569),r=t(5043),o=t(599),i=t(579);const{TextArea:c}=n.A,d=r.memo(e=>{let{value:a,onChange:t,validationType:s="text",componentName:c="SecureInput",fieldName:d="input",onValidationChange:u,...m}=e;const{validateInput:g}=(0,o.j8)(),[p,f]=(0,r.useState)({isValid:!0,errors:[],wasModified:!1}),y=(0,r.useCallback)(e=>{const a=e.target.value,n=g(a,s);f(n),n.wasModified&&(o.qp.logXSSAttempt(a,n.sanitizedValue,c,d),l.Ay.warning("Input was sanitized for security reasons")),t&&t({...e,target:{...e.target,value:n.sanitizedValue}}),u&&u(n)},[t,s,c,d,u,g]);return(0,i.jsx)(n.A,{...m,value:a,onChange:y,status:p.isValid?"":"error",title:p.errors.join(", ")})}),u=r.memo(e=>{let{value:a,onChange:t,validationType:s="richtext",componentName:n="SecureTextArea",fieldName:d="textarea",onValidationChange:u,...m}=e;const{validateInput:g}=(0,o.j8)(),[p,f]=(0,r.useState)({isValid:!0,errors:[],wasModified:!1}),y=(0,r.useCallback)(e=>{const a=e.target.value,r=g(a,s);f(r),r.wasModified&&(o.qp.logXSSAttempt(a,r.sanitizedValue,n,d),l.Ay.warning("Input was sanitized for security reasons")),t&&t({...e,target:{...e.target,value:r.sanitizedValue}}),u&&u(r)},[t,s,n,d,u,g]);return(0,i.jsx)(c,{...m,value:a,onChange:y,status:p.isValid?"":"error",title:p.errors.join(", ")})}),m=r.memo(e=>{let{children:a,onFinish:t,componentName:n="SecureForm",enableSecurityLogging:c=!0,...d}=e;const[u,m]=(0,r.useState)([]),g=(0,r.useCallback)(async e=>{try{const a={},s=[];Object.keys(e).forEach(t=>{const n=e[t];if("string"===typeof n){const e=o.SR.sanitizeText(n);a[t]=e,e!==n&&s.push({field:t,originalValue:n.substring(0,50),sanitizedValue:e.substring(0,50)})}else a[t]=n}),s.length>0&&c&&(s.forEach(e=>{o.qp.logXSSAttempt(e.originalValue,e.sanitizedValue,n,e.field)}),l.Ay.warning(`${s.length} field(s) were sanitized for security`)),t&&await t(a)}catch(a){throw console.error("SecureForm submission error:",a),l.Ay.error("Form submission failed"),a}},[t,n,c]);return(0,r.useEffect)(()=>{if(c){const e=o.qp.getRecentEvents();m(e.slice(-10))}},[c]),(0,i.jsxs)(s.A,{...d,onFinish:g,validateTrigger:["onChange","onBlur"],children:[a,!1]})}),g=r.memo(e=>{let{children:a,validationType:t="text",name:n,rules:l=[],...c}=e;const d=r.useMemo(()=>{let e=[];switch(t){case"username":e=o.PT.username;break;case"email":e=o.PT.email;break;case"password":e=o.PT.password;break;case"projectCode":e=o.PT.projectCode;break;case"materialCode":e=o.PT.materialCode;break;case"plantCode":e=o.PT.plantCode;break;case"text":e=o.PT.text(!1,0,255);break;case"richtext":e=o.PT.richText(!1,0,1e3);break;default:e=[]}return[...e,...l]},[t,l]);return(0,i.jsx)(s.A.Item,{...c,name:n,rules:d,children:a})});d.displayName="SecureInput",u.displayName="SecureTextArea",m.displayName="SecureForm",g.displayName="SecureFormItem";const p=m},6399:(e,a,t)=>{t.d(a,{A:()=>T});var s=t(5043),n=t(8139),l=t.n(n),r=t(8574),o=t(1128),i=t(5391),c=t(2701),d=t(2366),u=t(5296),m=t(3944),g=t(1857),p=t(4414),f=t(8446),y=t(8855);const h=e=>{const{lineWidth:a,fontSizeIcon:t,calc:s}=e,n=e.fontSizeSM;return(0,f.oX)(e,{tagFontSize:n,tagLineHeight:(0,m.zA)(s(e.lineHeightSM).mul(n).equal()),tagIconSize:s(t).sub(s(a).mul(2)).equal(),tagPaddingHorizontal:8,tagBorderlessBg:e.defaultBg})},b=e=>({defaultBg:new g.Y(e.colorFillQuaternary).onBackground(e.colorBgContainer).toHexString(),defaultColor:e.colorText}),P=(0,y.OF)("Tag",e=>(e=>{const{paddingXXS:a,lineWidth:t,tagPaddingHorizontal:s,componentCls:n,calc:l}=e,r=l(s).sub(t).equal(),o=l(a).sub(t).equal();return{[n]:Object.assign(Object.assign({},(0,p.dF)(e)),{display:"inline-block",height:"auto",marginInlineEnd:e.marginXS,paddingInline:r,fontSize:e.tagFontSize,lineHeight:e.tagLineHeight,whiteSpace:"nowrap",background:e.defaultBg,border:`${(0,m.zA)(e.lineWidth)} ${e.lineType} ${e.colorBorder}`,borderRadius:e.borderRadiusSM,opacity:1,transition:`all ${e.motionDurationMid}`,textAlign:"start",position:"relative",[`&${n}-rtl`]:{direction:"rtl"},"&, a, a:hover":{color:e.defaultColor},[`${n}-close-icon`]:{marginInlineStart:o,fontSize:e.tagIconSize,color:e.colorIcon,cursor:"pointer",transition:`all ${e.motionDurationMid}`,"&:hover":{color:e.colorTextHeading}},[`&${n}-has-color`]:{borderColor:"transparent",[`&, a, a:hover, ${e.iconCls}-close, ${e.iconCls}-close:hover`]:{color:e.colorTextLightSolid}},"&-checkable":{backgroundColor:"transparent",borderColor:"transparent",cursor:"pointer",[`&:not(${n}-checkable-checked):hover`]:{color:e.colorPrimary,backgroundColor:e.colorFillSecondary},"&:active, &-checked":{color:e.colorTextLightSolid},"&-checked":{backgroundColor:e.colorPrimary,"&:hover":{backgroundColor:e.colorPrimaryHover}},"&:active":{backgroundColor:e.colorPrimaryActive}},"&-hidden":{display:"none"},[`> ${e.iconCls} + span, > span + ${e.iconCls}`]:{marginInlineStart:r}}),[`${n}-borderless`]:{borderColor:"transparent",background:e.tagBorderlessBg}}})(h(e)),b);var v=function(e,a){var t={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&a.indexOf(s)<0&&(t[s]=e[s]);if(null!=e&&"function"===typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)a.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(t[s[n]]=e[s[n]])}return t};const C=s.forwardRef((e,a)=>{const{prefixCls:t,style:n,className:r,checked:o,onChange:i,onClick:c}=e,d=v(e,["prefixCls","style","className","checked","onChange","onClick"]),{getPrefixCls:m,tag:g}=s.useContext(u.QO),p=m("tag",t),[f,y,h]=P(p),b=l()(p,`${p}-checkable`,{[`${p}-checkable-checked`]:o},null===g||void 0===g?void 0:g.className,r,y,h);return f(s.createElement("span",Object.assign({},d,{ref:a,style:Object.assign(Object.assign({},n),null===g||void 0===g?void 0:g.style),className:b,onClick:e=>{null===i||void 0===i||i(!o),null===c||void 0===c||c(e)}})))}),A=C;var x=t(8835);const w=(0,y.bf)(["Tag","preset"],e=>(e=>(0,x.A)(e,(a,t)=>{let{textColor:s,lightBorderColor:n,lightColor:l,darkColor:r}=t;return{[`${e.componentCls}${e.componentCls}-${a}`]:{color:s,background:l,borderColor:n,"&-inverse":{color:e.colorTextLightSolid,background:r,borderColor:r},[`&${e.componentCls}-borderless`]:{borderColor:"transparent"}}}}))(h(e)),b);const k=(e,a,t)=>{const s="string"!==typeof(n=t)?n:n.charAt(0).toUpperCase()+n.slice(1);var n;return{[`${e.componentCls}${e.componentCls}-${a}`]:{color:e[`color${t}`],background:e[`color${s}Bg`],borderColor:e[`color${s}Border`],[`&${e.componentCls}-borderless`]:{borderColor:"transparent"}}}},j=(0,y.bf)(["Tag","status"],e=>{const a=h(e);return[k(a,"success","Success"),k(a,"processing","Info"),k(a,"error","Error"),k(a,"warning","Warning")]},b);var S=function(e,a){var t={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&a.indexOf(s)<0&&(t[s]=e[s]);if(null!=e&&"function"===typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)a.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(t[s[n]]=e[s[n]])}return t};const U=s.forwardRef((e,a)=>{const{prefixCls:t,className:n,rootClassName:m,style:g,children:p,icon:f,color:y,onClose:h,bordered:b=!0,visible:v}=e,C=S(e,["prefixCls","className","rootClassName","style","children","icon","color","onClose","bordered","visible"]),{getPrefixCls:A,direction:x,tag:k}=s.useContext(u.QO),[U,E]=s.useState(!0),T=(0,r.A)(C,["closeIcon","closable"]);s.useEffect(()=>{void 0!==v&&E(v)},[v]);const $=(0,o.nP)(y),I=(0,o.ZZ)(y),R=$||I,F=Object.assign(Object.assign({backgroundColor:y&&!R?y:void 0},null===k||void 0===k?void 0:k.style),g),N=A("tag",t),[O,M,L]=P(N),B=l()(N,null===k||void 0===k?void 0:k.className,{[`${N}-${y}`]:R,[`${N}-has-color`]:y&&!R,[`${N}-hidden`]:!U,[`${N}-rtl`]:"rtl"===x,[`${N}-borderless`]:!b},n,m,M,L),z=e=>{e.stopPropagation(),null===h||void 0===h||h(e),e.defaultPrevented||E(!1)},[,V]=(0,i.A)((0,i.d)(e),(0,i.d)(k),{closable:!1,closeIconRender:e=>{const a=s.createElement("span",{className:`${N}-close-icon`,onClick:z},e);return(0,c.fx)(e,a,e=>({onClick:a=>{var t;null===(t=null===e||void 0===e?void 0:e.onClick)||void 0===t||t.call(e,a),z(a)},className:l()(null===e||void 0===e?void 0:e.className,`${N}-close-icon`)}))}}),D="function"===typeof C.onClick||p&&"a"===p.type,_=f||null,H=_?s.createElement(s.Fragment,null,_,p&&s.createElement("span",null,p)):p,q=s.createElement("span",Object.assign({},T,{ref:a,className:B,style:F}),H,V,$&&s.createElement(w,{key:"preset",prefixCls:N}),I&&s.createElement(j,{key:"status",prefixCls:N}));return O(D?s.createElement(d.A,{component:"Tag"},q):q)}),E=U;E.CheckableTag=A;const T=E},8348:(e,a,t)=>{t.d(a,{E:()=>l});var s=t(6649),n=t(3719);const l={getUserPlantAssignments:async function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{if(console.log("Getting plant assignments for user:",e),console.log("Is authenticated:",(0,n.wR)()),!(0,n.wR)())return console.warn("User is not authenticated, cannot get plant assignments"),{assignedPlants:[],primaryPlant:null,effectivePlant:null,isPlantUser:!1};const i=(0,n.gf)();if(console.log("Retrieved token:",i?"Token found":"No token found"),i)try{const e=await s.default.post("/auth/validate",{token:i},a);if(console.log("Token validation response:",e),console.log("Plant codes in token:",e.plantCodes),console.log("Primary plant in token:",e.primaryPlant),console.log("Is plant user:",e.isPlantUser),e.valid){if(e.plantCodes&&e.plantCodes.length>0)return console.log("Plant assignments from token:",e),{assignedPlants:e.plantCodes||[],primaryPlant:e.primaryPlant||null,effectivePlant:e.primaryPlant||e.plantCodes&&e.plantCodes[0]||null,isPlantUser:e.isPlantUser||!1};if(e.primaryPlant&&e.isPlantUser)return console.log("User has primary plant but empty plantCodes, using primary plant as assigned plant:",e.primaryPlant),{assignedPlants:[e.primaryPlant],primaryPlant:e.primaryPlant,effectivePlant:e.primaryPlant,isPlantUser:e.isPlantUser||!1};console.log("Token is valid but no plant data found in token")}}catch(l){console.warn("Failed to validate token for plant assignments:",l)}const c=["userData","qrmfg_user_data","user_info"];for(const e of c){const a=localStorage.getItem(e)||sessionStorage.getItem(e);if(a)try{const e=JSON.parse(a);if(e.plantCodes||e.assignedPlants)return console.log("Plant assignments from stored data:",e),{assignedPlants:e.plantCodes||e.assignedPlants||[],primaryPlant:e.primaryPlant||null,effectivePlant:e.primaryPlant||(e.plantCodes||e.assignedPlants)&&(e.plantCodes||e.assignedPlants)[0]||null,isPlantUser:e.isPlantUser||!1}}catch(r){console.warn(`Failed to parse stored user data from ${e}:`,r)}}try{const l=(0,n.gf)(),r=await s.default.post("/auth/validate",{token:l},a);if(r.valid&&r.isAdmin){var t;console.log("User appears to be admin, trying admin endpoints...");const n=null===(t=(await s.default.get("/admin/users",a)).users)||void 0===t?void 0:t.find(a=>a.username===e);if(n&&n.assignedPlants)return console.log("Admin endpoint: Using user details for plant assignments:",n),{assignedPlants:n.assignedPlants||[],primaryPlant:n.primaryPlant||null,effectivePlant:n.primaryPlant||n.assignedPlants&&n.assignedPlants[0]||null,isPlantUser:n.assignedPlants&&n.assignedPlants.length>0||!1}}}catch(o){console.warn("Admin endpoints not accessible (expected for non-admin users):",o.message)}return console.warn("No plant assignment data available for user:",e),{assignedPlants:[],primaryPlant:null,effectivePlant:null,isPlantUser:!1}}catch(i){return console.error("Error getting user plant assignments:",i),{assignedPlants:[],primaryPlant:null,effectivePlant:null,isPlantUser:!1}}},updateUserPlantAssignments:(e,a)=>s.default.put(`/admin/users/${encodeURIComponent(e)}/plants`,a),checkUserPlantAssignment:(e,a)=>s.default.get(`/admin/users/${encodeURIComponent(e)}/plants/${encodeURIComponent(a)}/check`),getUserById:e=>s.default.get(`/admin/users/${e}`),getAllUsers:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return s.default.get("/admin/users",{cacheTTL:3e5,...e})},getAllUsersRealTime:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return s.default.get("/admin/users",{useCache:!1,...e})}}},9799:(e,a,t)=>{t.d(a,{B:()=>n});var s=t(6649);const n={getAllLocations:async()=>{try{return await s.default.get("/master-data/locations")}catch(e){console.warn("Main locations endpoint failed, trying fallback:",e);try{return await s.default.get("/master-data/locations/fallback")}catch(a){console.warn("Fallback endpoint failed, trying simple endpoint:",a);try{return await s.default.get("/simple-locations")}catch(t){throw console.error("All locations endpoints failed:",t),t}}}},getLocationByCode:e=>s.default.get(`/master-data/locations/${encodeURIComponent(e)}`),searchLocations:e=>s.default.get(`/master-data/locations/search?term=${encodeURIComponent(e)}`),createLocation:e=>s.default.post("/master-data/locations",e),updateLocation:(e,a)=>s.default.put(`/master-data/locations/${encodeURIComponent(e)}`,a),deleteLocation:e=>s.default.delete(`/master-data/locations/${encodeURIComponent(e)}`),getAllProjectItems:()=>s.default.get("/master-data/project-items"),getItemsByProject:e=>s.default.get(`/master-data/project-items/projects/${encodeURIComponent(e)}`),getProjectsByItem:e=>s.default.get(`/master-data/project-items/items/${encodeURIComponent(e)}`),getAllProjectCodes:()=>s.default.get("/master-data/project-codes"),getAllItemCodes:()=>s.default.get("/master-data/item-codes"),getItemCodesByProject:e=>s.default.get(`/master-data/project-codes/${encodeURIComponent(e)}/items`),testLocationMaster:()=>s.default.get("/master-data/locations/test"),testSimpleLocation:()=>s.default.get("/simple-locations/test"),diagnosticLocationMaster:()=>s.default.get("/master-data/locations/diagnostic"),getSimpleLocationCount:()=>s.default.get("/simple-locations/count")}}}]);
//# sourceMappingURL=39.3a8b2b10.chunk.js.map